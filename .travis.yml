sudo: required
dist: trusty
services:
  - docker
stages:
  - name: build
    if: branch = dockerize_service
  - name: deploy
    if: branch = dockerize_service
jobs:
  include:
    - stage: build
      language: java
      jdk:
        - oraclejdk8
      env:
        - MB_URL="tcp://localhost:61616?jms.redeliveryPolicy.maximumRedeliveries=1"
        - MB_USER=admin
        - MB_PASSWORD=password
        - DB_URL="jdbc:postgresql://localhost:5455/mttw"
        - DB_USER=user
        - DB_PASSWORD=password
      before_install:
        - docker-compose -f infrastructure/docker-compose-services.yml up -d
        - chmod +x mvnw
      script:
        - "./mvnw install"
      before_deploy:
        - git config --local user.name "raul.estrela"
        - git config --local user.email "rsaestrela@gmail.com"
        - git tag $TRAVIS_BUILD_NUMBER
      deploy:
        provider: releases
        api_key:
          secure: dubW7++ixLKrOFX/bC1at+ryGC25ADHdvPwgnvFG4Ks26zD3tjUgvGaV1AI88JeyiyXbKffaVeMDHY12z1lOhGCkitfVRNMSW1Z2uriOBaYA7y6QWAgxGOozO35jA3HoiAkcwfqbIh8CEqVwVgFq0pXityw/6Id5OIMNLm6c0QQT65XVntpuPKGyplQCgkpo1cY42NWUhmeU6iYcCYlVCSKyIzZD8NEcM36k2HZuC3UJwciqyRvtP0+v4MuvRzJ6/ItGudTJVj+ddVjUv2q0ph7qzBg/DiWMXZ8zbNBpLB59iL5q2qGc59HybNu6/iF+SIU8zBKwq6Ed8kasCjtpWCR7Di9hRFom7oCL51nugsBkNJzLubqpaYElET00t49a/b+28s+MF4k5WwzEFdp7ZiOQurrhAdGrvjOEfYmf4VAXLv9VtSg0wHfz8qKjwvr8uv6ixEgZM0bXUSx1JeF71486g5/qvAh55D3xTttjCEec9RqWRHyQ1J3hh4Oo3nIjJlbLaev8fl4PLTcv1Ih1K4MCRKncRHvxc2xeIkMjlzOxmZNMMa8SZsQ6cP0+kzWIS4uGAOE/4coyAWcgX5LCiPaXnVTH5owfjWXWYKQ0IfHP2B09JAarTllAj8FZO2qL0H4B667iQgDcGpaCLwX4Hu49vpGyY7UFE1ODqMyvClM=
        file: target/mttw-0.0.1-SNAPSHOT.jar
        skip_cleanup: true
        on:
          repo: rsaestrela/message-to-the-world
          branch: dockerize_service
    - stage: deploy
      language: bash
      env:
        - CLOUDSDK_CORE_DISABLE_PROMPTS=1
        - secure: YhGm6kGMvb5KbxKw4wTOGjwadVQbOemICnkOq01JCNGLBFXtTkkS+HJ6Z1uswXCrCJ70j22NmzatuA20lH0IN9hmWtGIkFh8AYehwHjyZfYsg1BHRhBCnX7Xp0R6tFkPQfWWE/x9N2aVmDQbnk9to2w8uFxVldC9jmxu1dlowQDmV7LCu82eYPferOUwTWPCaIzZBdcJJm/KnyM6vh+TkTAsgYAKK2Zva3qKbiskDjU4+eNOMqK6H9weTCnlUE9zdZHFuVPqc1Gvl2O4F/kfRTrjvT8Ia5zznEMR/wIiSpriC0DsQMo1Mc11XJ3DqsPs8jsIgGxUusHPBvG3KP662J+3pK/h6rqOlIbyJYz7BTy0Pz1cnBBF4d64/AtkENOftTAWJjFO+RTCKpJd3P98XNUZDIYOnWi9IFLXYBAUdT7P/OHW+Le78LcSwDlnGlNLNVSVAB5foZq5II/PM7Z8bUo3H/QdCnteWYcNYqHDAzeQZSGENVDqLbAVAOssc18tYvpTKj5Mq/jIhy0qUVYmHseg3Rip90ocNTKB0Ama1+T79smE7Jj+GiPjUdHc0gkpDQ96UucuRtoQ1Q1ihzHmFb5RNwt50xIXQ0mckCdmIKH23AA13NeCeodrT/x5/m4LicoY+G2C05DuqdvQMQO4WLYCi+S/tMxVl0vjMsekMYY=
        - secure: EQ5v7rOv+YbnhgoAjnTWA27C+JdSvXaKdh4t/s46hcJhu+Vwtm2NiWCuJOE8v2N0BWxJaSj4gUKpTqxO4fYHG4Gok6YTZkHo4zLZlWPgXdW52ps5WQonn5aGcJGZoIklYng+BJD8GCzquAaz9I5MKJVa6SMsot9fFRiOLBH8cbr9BYly+7RojzJNprtWcPtgx4qqJ0k3CySeRtE6lZn9ME8YRIRPX1Q7i7H0UoxMyP3sFTKPLbA+JJcPXjg95nnRskL5QSZycUcS53t20lljLkv+AVldTwUoUfHEH5VIXKWu+0tIQkZtR6Tx6barGLxjev3ggFyOmxCIaB9BTFcH7IYdAwdb+z0XC0dAxivd8o1ueZzHlsxawF+QKknhxj0SjRj6lDoN4ucsI1WIXBItyagIVHfdhsg7AAbSL/+0fHE82aLqa4vRLyojpZwkLeDTIrElKF3L9CTEsOtAX0RdIU4EABP1Z/RRsnoowoDE72wLBS45bYCYxiuaKOdVmtL6cldAPwA8vIp/IurHpwaK18trTcb5VZigUQT+9/FvlUI3kp6NGZt9JDs3i+jdEQ316wQyON1ItJ8LqDjDlygsenF/TR4kEHA13bTtxzmhDkJA81s/EcDWWIvjZel0mtW5QJ8boSoLxlA1wzVtqHvrVhmL98SQSgBivceaJD+Ot3U=
        - secure: D9XIMDgAb5RXT+H870briDIn0Vp9O02bu65k6TJjRbzqPcoOi5SIFr+X8Lv/44q3vFE0RcUTMyrFBdvTpeXCK+FNAyLDS+HauCTdNGV64PaqPNeMuAQ1CneeB8KhjjQ/uLDsGAoPqeLHXLVaWNflamvugybrlrMKYc7h7GE/CSfUwNx+nz9Pfzi+UHnYTfSMVGF0tAHfQkmic3dzC2sMsjTOL099WYIFd4mqjHWVOxmmxRyQvF57y3TX/W9EvsKT8OLZfTpS11+8LVpzFVg/sIErDcDmf4iPhgUt/rm2AGFzpE4Ohj83j7BPC7Pv7gtmmvQ+lJVnrojpD+fSUQqhagPNeuejLVHgs4VgDnYVWQQWMUUO+jKb2O5vHzWdBPWzMZxPMMyrajfVH688antkjxWzhECbOWgIzx4obDZzK+B+5UfYrFim+tox0hfGQXvoted1jCtaZmxeSig1QasVRlUHL4IvgrzHpVbOT5ZYpMuQRUh21Ka3uOareueSMVIpnLUuTnFxGHEsuZb2vcApfeta7MMBIuv9IenkdCPcUJ7VaGcy1+SXynSHM4wlEg7OFms+glh3oYSBv5AFgyFQzmx3LQxpoP3j+PfskD9yq5R5GXur4HrYMyrC9WkAjI/ZJUHfREWIZWBuIh7UptOdCRNB5GDdf+orrcuYoZevex4=
        - secure: El6vSjHwq39usPPM6JE+1zxuiMzzx7t1MlP2uEVrYCPv/Dqwk927zOY1/KuiIYqHQTGKIJNdeuiST/ef1nJDUtrpbp4+c7y8N1ESlEcDp/wyYPWFZglZ0sudIhrQzK1TkmYOQgip9vrT6V2PP3Jju0Vt64QVbxSfokssElcpU+pT+v2UnhDK13V6pJGMJ9V+niAEHtfC9076jp7GZS5K7/6+4shy6gAI0HYo8Bk6Fo1KNkNlzAK7Lo+znA83aH1mrJx3UUax4sLMp86/FHUEHYtV2yZAYLevq8HVzJJ8Zg/x56D+2hBxuYRD81QFWvabtnpjP8FVEHOKDpv5Zx6xuBfE/pKXw55p1yypJmqAhZsbK1s7SX0PF+KUCcHgHBs1VcRbabKJVu0Xyr087TxiRd4YeeVs/+yfHVOZVgtoJ+yNs4f/NnXozroK9K7GzgepUV/SJQVNQoSKSpaVbN5hUZ9Ho0016E8m5IhyYnJ0u+UxmIcrZx45cxqSQGtCLWKTFG9QVR6BSNN0dMW1XEnECM10R/x6xgzA90O0nXFov7CL3OGZm03lmnTji0Hs5QrTrkNU4AZrA0LAFgagLVYaUwDX3I37bPNCJPy1nV62of9QcsVXKiUt78VMf6HONlmSNrpmGMFDdZH+okI9KFg/g+0feuMoz0Bq4yqyNaI/EZk=
        - secure: vdzB2rdyIczVIxoTx+a0HZKmHc3wN9fppoqdnNqRJbB5hizsXG+PSvWAfnLB0hmrcezUsJxVo787ffOwgwCAxl+gIwNXvUMLdFGHBbKb57VbYzvZfUjrvE7OvJkwVtJqvbmX4EMuQmvWFWYknjUhQwjUlga8I7GWRQoERuS7gthQKjPNImAb71hBsv1BCglFtqlpB3No7JXMBvA5Xt5Pph5zTLPM5dSCygHeETMcOoTKV2u+FegxDq+BRQfxgK231jGr+gQfJiNtBZoUB1cIqJ+AhZ8Jjsl7mYa0805lRXLB9n0GmL4p9JYgA0NPAfEwBAzx0gRoWolDEVIEsBFlqsBH50KHmDx4lDu+WMe9i5T1GFP81UCURm+SYmjHqRQWIaxBiPhHZqqDEnuugAGJow3oxKlfXeysruvMpntAmUQcjTB823b6H5tWSSrriteRy16+FgkhkeB7vJANhmEQifcWLbG1uVgvsHETf6TfJGCJFV6y4HwNK7pSEN5RzdJned0GE6DuFUMMQGrRUj6SCxARI9lq/+rlCG6EbvQoEgFvAt5rE9xu4nSJ7kNX0TUAlsGY+Awy5JMYeiDuZ5xXC59oGy5mznvk4p48bohXnLF9T8Hde+oguaxwoZCZumAXb40c0JafB7oLNCJPaEqxciPhcMbVZp4lF1gYXV1tk5A=
        - secure: Bren9qunfci9vvMLzJ40DEh2Ao5JN+GFI4fn+JDLlsjEkM3b9JrE1TlD+Minm44NkqoF/n20C3jW4XYCm6iXcXc/Z5ppG88qkF943/cXEs5YOd5xJC5HYl+ik9aNInFHJ/5L5hNpCwuvrmzqVOedtTtaszbhfqKzC8mP81LSHhE/Rtra3mWuQl3PvEfWRNfPhFl6gk1k8inKNTHm8UNGt2Vb7c7mjQB5lof9z24kicx1x3ilHCXDewZj0c0/Z2CJJCRaVc90E14AaKpdMNLoKCU9vO8uU+mc0S6FgpKBmij7av6Ab2006DXAouB90vsAWeZ++lzJChyCDOyAi/iTL/WamjTwelab6jBhYrVFcXkvaGmBVaT8wfBDVIeIvpfC7vw16rXpVGeKoWrIrUq2L21d9Lq5/ZQwIv4ByJsinmYp3lZK4/XuF08qLc5J3gptMHGKcYJzRUo/MInCZkVOrxq6iwMTi30ttnUpoqKgwqOM6tVyOBDZhBYqDjRPZ+3g6/BesJhvmdkbndnX5DBFu9jM61SqCDRpIvdd89spax176Wc8Ip8cuvUi2MjMa81qs+33KbYi0JnGfRHi959+HCuFGpq1nC7c86pU06w4fAuq+2KvepoArU6tRRl9fR+fZHhFeN/Bbcp2PRHY+n7SltZiBsHoU8oYUmHkn63InEg=
        - secure: DLMuXeJxjNolzMtZzSUATVxJ5tlHTY6TOGOJPzXb9SDQEKQY/zbm/OonKGZWfcqdRIzbpm+ahrtE8EWxOqjlWgCb1iO7HAm50ldtcGGCPPiYrydrVHFhmI2DECs3qXaGDydwq2i3BPqavAUZcffrUF19OBlS76Fb6aX61KWrraRZpYKQNAi2dqUjy1uufnDGPTm2AV/txuB6V/fk3cilSkA1RBt60d4QGDQ0/ZBi33q5FzhTmWQgegYR+jy96D41EikvEsQqWcdBEnC9l2H2OxJkEPEKmsYrGL2ZSvzVWC4DOaUr8Ygxqfj3cbdlyDDFWV40EJXwqlcpX+YaesQcB71TUOtIgk20j284D6APhaLOGfHHdyK3bF4BWEInKD7cILjT1stcTr5vs2e4un3Cr7kfhjnVL57XqL4INVw//U1m8YgvA8VjNmfMNj9oF+8FOXCnrA4DE8Na0pbt67sM4vLBk+i8mW41z6XVyHSHLq5eRXbLhpMQ9fnRH2hp8r5rtjl2bZ17SaEo/ifPeHZfAS9nZtTb6fbG/H/hedblf+KT4zAnHrjdJ3ji8t5VeReu07mYJu/0UB2U6p//XUGM855VKPZyWQqAX8kaZsfuvjhs6yBixFEkLY1xPcpXdJ5WuyHsOZtKZ0BVUcPQKnc7KRIT4ynqEHqjMsrdF9xCpHA=
        - secure: wcH8hGjP17UdBGd3Bmpa38FSNIVDKbckVp2aQDvip9f7M+r2c30jQZHWbqnnq107jck0d1KSoO4eJD6tzGurBmlrEsUG/+wNM7tcBzU2Gf+C3MGvwl5tALz5N7F6aSZKOjiVnLcqG92KfBVEet94aYXn4FuSKwCkC0Qf0vn6wWJ9GWNvrS9EL4C5m7+TEGtjkef6NWrSvCkMoXTgsNYRklJUUOBe4YhFgFCnQsz248nUDdoX3xAJ0T+7c0jibyy00XDJ7c/QURA+Reb84XVe6+1q3sn78H8M7gOt2IFfQtBGJ1Oras0Tj9W84tQS20C/3uPlW1X0Vx+56aVCX81UCZaZlcX1LPhCgjQuqAClqoCSR/grKGDVXBaVMWhNkjSqWDkD3o1QIw/+ZeKGDxKo/0HSO1xQ95RvPt3ju1njnygsFgpW0eb6QBjK3HNIOliW4jCIBbb7scaoEPya3KlzR1Kjsfo1mLet3UT5KKqUBDHmAM4QxdeBWj+AXO+PpT3RXBYqSERALWmF1YTruvUo9+KqKZ9mXtZ8RjzWcSK9QOHILrhccb9vHUISItg19bANrfGpwd8Jg/yXjc729LyyEk1rj3Col71HrAEC4lpMZ44EduYQvHcf+dRSRv3jZ1tSrV269nS46XEv43bgTyfykQyieungc4b0X0gv897EweA=
      before_install:
        - if [ ! -d $HOME/google-cloud-sdk/bin ]; then rm -rf $HOME/google-cloud-sdk; curl
          https://sdk.cloud.google.com | bash > /dev/null; fi
        - source $HOME/google-cloud-sdk/path.bash.inc
        - gcloud components update kubectl
        - gcloud version
      deploy:
        skip_cleanup: true
        provider: script
        script: bash infrastructure/push_image_gcr.sh
        on:
          branch: dockerize_service
