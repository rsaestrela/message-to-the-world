sudo: required
dist: trusty
services:
  - docker
stages:
  - build
  - name: deploy
    if: branch = dockerize_service
jobs:
  include:
    - stage: build
      language: java
      jdk:
        - oraclejdk8
      env:
        - MB_URL="tcp://localhost:61616?jms.redeliveryPolicy.maximumRedeliveries=1"
        - MB_USER=admin
        - MB_PASSWORD=password
        - DB_URL="jdbc:postgresql://localhost:5455/mttw"
        - DB_USER=user
        - DB_PASSWORD=password
      before_install:
        - docker-compose -f infrastructure/docker-compose-services.yml up -d
        - chmod +x mvnw
      script:
        - "./mvnw install"
    - stage: deploy
      language: bash
      env:
        - CLOUDSDK_CORE_DISABLE_PROMPTS=1
        - secure: RUgNAcjD3mDVEUAnWsgBaS3MAcT+9AarowAmhROeY+qkERKvXlV/fGgMLg6kHbybO9hW4m4HvQubhBEuAXcBb7/OtSNfE9+IeBqE9Z32GFsw6SlBdhImmMX3xQ2GMPWtDglzpIheCCeSf6W89p7Ewh3nD0+Bmng/ldtfFcFCr1ehtYWrnFSkLmjAD7V6Ozdb+nC/FknDLyRU+6+Wn4OfK59BiJGR8c9YVdGdkuCUXeWX1mWdR/QkIL1oC2Nb5JXtIzUmgIT/bRDjwJa5+H11vLKFUsQGEMbUxnl6QH2mo9iv2TjBjR94YYOBNWjkBrYTZ0VCdrOQP+ZKoBbSIvZ51Zy6zdIXuiNclMc7aTzy0VBImTa3Dk85NutfJsPkiPD/mfwAteynfg+dLKAfmvwGym93Q+NKKeIm9oaeCkN2HmHfZxUKYFjovfRVogKk3iNZRztGLRYrt5kz59TS0ofjzZBCx0EBN7Wn+5nAj7ITEnDcBagO1DSoQNkaBQFL4+Iunpph0KYYFs7sQYHTn/unzbiV984XmOKHQnGIXar6kB1ehJfWASE4gQdcbd10ZW+ITIJbPRVqjOCuMxAGh5PQ5bZaSanef6P+DdMSna7ZQ/tN1RTcfSeU5X8y+ZWmKX1hA1iqURaPXcvT9bjZGweQ6FwHmuIxqDgkPpPWz+W0KZo=
        - secure: odoaRDKxB2ACC6MHWj3tAR8vEwzvLAy3WbuUTHY+JjGSyyOnmIYWlIBSNtI+40bQFKrCaz44f/UKcgBo/wp+XF8ExPOrkFI0fCWLQT5T/JRhNxUbfJq1nzuhg2iAW/9R+z8D6IKHCfC3nm1od+8L4jky1lTOVtm4nmjg+BrteGTvCfK4+48fuqOEGDcKw/gBxQWL1uQBptPeCOszVuFYcIiQlq4MfPIivknMNAkdnsT3gKZkM/UBG1zBzmzqCle/bAqTL55fbXBdU9JySLNTzIrXR8bDfTBisMlH/RPHeA2rRdjI+5XhSVetmb55kOxVVeIpQ8wP9tiPl0ZtvJQeB562p39xG1Q+4U6F+LquaJaQy0+aPZ7Hv28Tqhr/KMNoQmrDWVpeR5DYJ7Ind4mQ+Zj32ySsvyQqoc2rlH64fJTQg59a379bWkse/poF7DZf0ZSo9/ucXulN3nLwaIAT6kX7QUug/5vYfj/wlvFVX3k+HGJpEqABjkzt5OCcC/9w4iyhfEkiPWDyQiLc7LZxELWaFnbZ1uUyPsSi1JTqvvsUQdYPMHvEaaKX1yI9MsBbi0D8O+uC5f5osBfSWAkxTyh8soyoA1qBWYpI7zXwVUe6eMIAmW4YGQhxaj8uOvnZP2kyBx+fMnSmI1CUaPL8bdL5wGkhtF+m3JnWEPVOWdI=
        - secure: Gxog+2rzu3DUU4zjspYEDEwjBr3qJmHPwo6wXKY4GS4GornvUoNdI455kIxszhZIMbGfLeYitO+RC6xa7Uj3F5HhOCY2axH/AKiTnRg2g9sROVMieO7CfvdBLV1nnZ3UYCn8KZhD695MWbFWJQfGR/Dzf6V41v83AqLU4KGVwWIyN8hJc7u8OHpMXqUbAXjNj2N4NKEsXH7naFVhX7LqWSuPZuCyCwlr63+17oKy36qOZqGoREpwUmGvh74Okirs/Y735ULDRGSOJenOxcQ0U9EWBPbK13FSFJr1HJqVueVEBqRe+VcqenrgGp6mR4j4q65NaBEoRlf4A98xvHo2c3DMBdZHbx2SwkpFs4ywZ9M9gxM96GvSEHgE00CY5QdD91sGu1FylHwMIPKB/XNqRCBnst3NbxmgUGplLn8uahsgYY4bOjR2KbkwQJv1oL2GJBfY7n/vEhwQfB4NvwA5uEfWmuidv5v4dkmPtKhsRxgkAeZz0VanDO1plzkRFnXD3l6bOgmdtvT6COgBqO8RBtx/LhzAhZGSD2dLyMFtXZ0GcSi0aB1uBHmrfCXDUNUjME+ZK6dtXtHMVAkK08ZrTJm67NVtEe1DDMNOq79ZluduRyDrW1UG+BKMPopxdsIBeWtpEttKwKp/uqYStYnbrS6kAgNKfLuSO9fVjgfJ/uI=
        - secure: olSDGkrfry2CZdCCbti3AMLXQwfKayTbDLzawxrTVQMOiCLmK3Vn1Lj0T/yFq3NrYVpthgkvU+0w786yqNrltS/vOXKi06a1xtqb1kbpquAbhxzZMMrE1WYrDSJSJKvdHxD+Lly5XAQxxXOA46XHGaufbtQPzjboONEJ0584QU7zTBlDQI9Rdy7wLt5Vz2t2G8Jt+Rzko+jROREvm55zGWH08F4y3R97hUaZl5PtbzdgmhS4xSO1SzeRL3ly3rG/XUCu1WCbHXtTf9ckby+LJ9C4KIHwfK3CZjxf2FzA21qTmd8oX6311CjxwgdVspc4gIKDbX8L6412z4Pxj5/KCf3cm6lWGbEu9I+Gk+NFHKGdyeGOcJNugo97uc0hzacKwLmXYc9XNe/2lQtPjmx4KDRj+LsiAVeJ82kYjOpHpdyqmXje8kHUAWzlwWXgPhYSnWy1oy+Ft89FXT3QAWB7gpVwAN8AAwRLemUMvhzJgObyeitRlEBWyB+ZQ/94daJOqO7Mxy9hvyH9wdG4loaZKW/iwAUgUsQwUp9F8xCiIl+ojJHjMRG89ylyPxfOmQMZOC4UdP35Mr8X+4UdYmRl8s2UzIcTqo4tGlrBlKvz1JIiAcY8QKSkJHaiu44ZRMCQHLrlcyLYK3NNYxLjV806FGrTlVKFBfusAnjkwm9uDDU=
        - secure: nZWM0ZklnJHNDq+bG0JslDQ59fbyQ3RxN8DcCNKkbUvxut2lJaJrGxN/XbsIC+v5hDNBJtxRIUGSOpxVtSPGMHNxOH5b019Qz5r8WyIRhPydBPNmmpO6Wf7crfil/BoGw6s9ieOohwc8Ks3H7YYYqLp47XsAJf/23sJN/lxXC/WwfqZS/GpL12CG7QCJo2qsxGCO5IiPk9UXtaA8J6wVbQO/rLMRBlZWsv4y3CHuoVQtm7qIqYBPp5rBx1vcBTuwjx48zEDMIwGVpLViKAy7OjSNFrOf52AC2AzV36EfNtDua7IxT/sOG1gs7QEKapznR/2sP957TKtm5PMNryfsEHa3W3h8XmzLunjvP9jBXaL02vVXJ//OYC97wmemJ3Y0xTr0KAdvPT9Z5eSSgusWtk0vw56zlPdA5pD3fqJnrh1NeP/doWn+1kcXVUvPT91nK+K+v5hlRx+7dZ0VCwypK58EYJIBgjYgd0EG+UdBJyBFtZNggmGWqTdwgzujwQ15udtp0tzvJ0SrDjSM+XaLASxesai/5sUccXlFIurjD4vQHX4zLC05qk/uafZViTV6calXVYCzovXh3SDav/A7tVaZHuL3dlv2oTNwaufXB2WA4f7elcqyWWjTP/1R9ugs14FGR2kaLeU3m45v+hggDKp0qIdFyITWgUJ1ey5uATk=
        - secure: oXqKWngnHkVvyidmJ5mAjgtpwcs21qyQ94L9gZansX0XrITP8E7RcNW4B/eFqXxdULue/KzP+qoBfnOHlbh3cFdvUfyM7YcTQS65o7fFJ2SGtMpreIKdf+Rgk/5MGKbIbGzDyQXl9YhS4iuGzGv4Nbc2t4Sy3hoYTEl6BqBqa0nMp/uEzV7prhyKQXrb9G+6l/ikl8amHOr3vT0ilPdaFVNnP7ev+5/0LQ7UwmtwQLtRw+kjLw2ikwTqK8c1zzSJvfJdUfq+6NW44bOlvS3XT/te/D/I48KLQfNEJPbjCaLXyLtjvVQUgmzcfKSUmbI4ga5kxv8VJ/13vrHpTfvFIRcJRrH6x7Im6EVfXcDM/qpiQbSdzkMBeDrWR0h/h9PNY1eqcX0Ta3zLo2jwynKg/RapARdmr79qrgfMH9bWG3DnAjHxpmxKf4eq0dYYwaJe/CM3rhO8nZUP8o3yekdYp+5cOa71/uUwq4GsRqXsZlVdhTYvp5WoeA8mJefy3zY7KpYvhFmHwpnpKCsWI2mKlBPcrIJ/cxh8CAZFVVwCrPmtSbf54Y5KSM6M8Xk0QLArSNQVskVnteEaYXkApRs+3TTruZU8dubsxT010RtqWgprPDK2Ngb2Xqv/R6Oay+jl2G53kRktyHwYhvhJ2WfpJdTKFpZbIz5BdacXjApoCwQ=
        - secure: Dm5U1jUiv0rPty+vTPXjOXuBEtn7gQKzrYg8CVQ6kasuCNg/9fRDCrLmvDyX+JFik0d08Bv3B17mUQ6JEIoJM87nsQK1bnG6vITZufmlNhe9UpOPmSsVnZmcR0Ql/1mn6sOzTirEHcEL3qVCNemnIyiprM23wI283Mjwdv2VjuDpBJDaS321zywwVQGlNZOZQHmOkQrkVCfBYYgJUgyuVuBHcnacaOTswLuzGKovF4f7IxaY1X+shgLsqJS+CLit3XgSHTu9hNsvQ9cEHZMfMDvakuCeN/PujTs2uIv75kYN1FP3H+DIPcziv6XEOq40lrhaYQ+Paml/PGPfjidYFINvXqfE9AzX9aYjeX3EE1PigHAKmZwSjMAa2LyB35aHsomXoFoyusDw8ZOXQj7dDMDHrLmkaGzIalzOaspWsX9KZs7dL9qpIZCgH3G+xDgLJYmUGYF9Ot8NVWPOqnrn5IQIM6gIEgB/KJwrMX3M0Qwg3GuFpeQY7SZh7ndRQ1VSr5CAWV8rA5H9dz9m1ho6bBKniB23Voa1Ih65LzD9TFzAbFbOy1JzbplPRzZWPAbdkeWg6OXlnvYFJdMboJ/+wFZk+KnjTAm1LaAMrIeCV1lPcRqwIQheSHTruVS/YlcGaHUcAu24Ldl44+FexqPF47iiLJC3czxBFDxVVoF7NrM=
        - secure: BosOViulWlHwLYqSlkGZS3r42BalPpsHOEwk97X9JNV0jO6xdba1IXHczJjx+oFqv/MdbdZDvgcGnE/1Sgx2t6/VFhiAn3sLLUG/s4QOR+oX3dtVfKx4C6W3gkIv/zdhSfwfxYwZV4RYMpCjPISso9w+QyYNcDlvb+2VMYRQTeoMq1kBJ/jZ241IRxjdj2mPqTX1696YAedz8jidF2lqZsMZb70Y0j826BjfBqsqdLeiSlLoVLEOioMWoc5VGVQxyjBprHIwOyxveVgZIaL0dfMVYDPSNxXVv8pkQUw074Q7oE86pUJz6eAtuGEek4aXMpxgDEO+nWZnUEcrygqOze8hjJ6RH3z0jXfNO3cMtcX8gCBsYrOpzS2BSHkBtdk0fHklOSqyXZU23Y8/Zi+1qDJPBGJebViFRFZGh9jaOZUB/5jwR46HmIG0MagKzgN5DHfKIeWMYJ8706dKKU2Xz5zn9bJIJzFRuM56Pd+xwsthgCS04I5xYddR7Yl57iaxc7NY/AFNfvVS4hkZL+D6gixqHgWWEcu6wCSyyO4o85BOYIkwrAUb6sEs49ql2HltBE3tEf2/0HugJYite+yx8gEQzMPl5qahwPnWPFSD8wah0IKaKH7I2aez4fj+z5Tbvbg/m2Ualc86AcIG2uqKyjKmRagd9UVBRR9V+Qk5hf0=
      before_install:
        - if [ ! -d $HOME/google-cloud-sdk/bin ]; then rm -rf $HOME/google-cloud-sdk; curl
          https://sdk.cloud.google.com | bash > /dev/null; fi
        - source $HOME/google-cloud-sdk/path.bash.inc
        - gcloud components update kubectl
        - gcloud version
      deploy:
        skip_cleanup: true
        provider: script
        script: bash infrastructure/push_image_gcr.sh
